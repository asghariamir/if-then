<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
<link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    <meta charset="UTF-8">
    <title>If-Then – Conditional Statements & Venn Diagrams</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MathJax for beautiful math typesetting -->
    <script>
        // MathJax configuration to handle dynamic content
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
          },
          svg: {
            fontCache: 'global'
          },
          startup: {
            ready: () => {
              console.log('MathJax is ready!');
              window.MathJax.startup.defaultReady();
            }
          }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary-color: #14b8a6;
            --primary-light: #f0fdfa;
            --primary-dark: #0f766e;
            --secondary-color: #8b5cf6;
            --accent-color: #f59e0b;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --light-gray: #fafafa;
            --medium-gray: #e5e7eb;
            --dark-gray: #6b7280;
            --text-color: #1f2937;
            --bg-color: #f9fafb;
            --card-color: #ffffff;
            --gradient-1: linear-gradient(135deg, #a5b4fc 0%, #c4b5fd 100%);
            --gradient-2: linear-gradient(135deg, #5eead4 0%, #14b8a6 100%);
            --gradient-3: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.10);
        }

        /* --- Global Styles & Structure --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; 
            background: linear-gradient(135deg, #f0fdfa 0%, #fafafa 100%);
            color: var(--text-color);
            display: flex; 
            justify-content: center; 
            padding: 1rem;
            min-height: 100vh;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(20, 184, 166, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(245, 158, 11, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            width: 100%; 
            max-width: 800px; 
            margin: 1rem auto; 
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg), 0 0 0 1px rgba(20, 184, 166, 0.08); 
            border: 1px solid rgba(229, 231, 235, 0.6); 
            border-radius: 24px; 
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        h1 { 
            font-size: 2.25rem; 
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem; 
            text-align: center; 
            font-weight: 800;
            letter-spacing: -0.025em;
        }
        
        h2 { 
            font-size: 1.75rem; 
            color: var(--text-color); 
            margin-top: 1.5rem; 
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem;
            position: relative;
            font-weight: 700;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--gradient-2);
            border-radius: 2px;
        }
        
        h3 { 
            font-size: 1.25rem; 
            color: var(--primary-color); 
            margin-bottom: 1rem; 
            font-weight: 600;
        }

        /* --- Enhanced Tabs --- */
        .tabs { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.5rem; 
            margin-bottom: 2rem; 
            justify-content: center;
            padding: 0.4rem;
            background: linear-gradient(135deg, rgba(240, 253, 250, 0.5) 0%, rgba(250, 250, 250, 0.5) 100%);
            border-radius: 16px;
        }
        
        .tab {
            padding: 0.75rem 1.75rem;
            background: white;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            color: var(--dark-gray);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .tab:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-color);
        }
        
        .tab.active {
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .tab.active::before {
            opacity: 1;
        }
        
        .tab-content { 
            display: none; 
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .tab-content.active { display: block; }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Intro Tab Enhanced --- */
        .intro-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            gap: 1.5rem;
        }
        
        .intro-text { 
            max-width: 600px; 
            font-size: 1.05rem; 
            line-height: 1.7;
            color: var(--text-color);
        }
        
        .intro-text strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .intro-section {
            width: 100%;
            margin: 1rem 0;
        }
        
        .scenarios-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        
        @media (max-width: 600px) {
            .scenarios-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .scenario-card {
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid var(--medium-gray);
        }
        
        .scenario-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        
        .scenario-card.active {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }
        
        .example-box {
            background: linear-gradient(135deg, rgba(240, 253, 250, 0.6) 0%, rgba(250, 250, 250, 0.8) 100%);
            padding: 1.25rem;
            border-radius: 12px;
            margin: 1rem 0;
            text-align: left;
            border: 1px solid rgba(20, 184, 166, 0.15);
        }
        
        .venn-display {
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(250, 250, 250, 0.8) 0%, rgba(240, 253, 250, 0.4) 100%);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .venn-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* --- Enhanced Lab Components --- */
        .lab-intro-box {
            background: linear-gradient(135deg, rgba(240, 253, 250, 0.7) 0%, rgba(250, 250, 250, 0.9) 100%);
            border-left: 4px solid var(--primary-color);
            padding: 1.25rem 1.75rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }
        
        .lab-intro-box p { 
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .lab-intro-box ul { 
            list-style-position: inside; 
            padding-left: 0.5rem;
            color: var(--dark-gray);
        }
        
        .lab-intro-box li {
            margin-bottom: 0.4rem;
        }
        
        .ai-disclaimer {
            font-size: 0.85rem; 
            font-style: italic; 
            color: var(--dark-gray);
            margin-top: 1rem; 
            padding-top: 0.75rem;
            border-top: 1px dashed var(--medium-gray);
            opacity: 0.9;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.75rem;
            background: linear-gradient(135deg, rgba(250, 250, 250, 0.9) 0%, rgba(245, 247, 250, 0.6) 100%);
            border-radius: 16px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        
        @media (min-width: 600px) {
            .controls-grid {
                grid-template-columns: 1fr 1fr;
            }
            .generate-button-container {
                grid-column: 1 / -1;
            }
        }
        
        .control-group { 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem; 
        }
        
        .control-group label { 
            font-weight: 600; 
            color: var(--text-color);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .control-group select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: 10px;
            font-size: 0.95rem;
            background-color: white;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .control-group select:hover {
            border-color: var(--primary-color);
        }
        
        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }
        
        .control-group button {
            padding: 0.875rem 1.75rem;
            background: var(--gradient-2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            box-shadow: var(--shadow-sm);
        }
        
        .control-group button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .control-group button:disabled {
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .control-group input, .control-group textarea {
            padding: 0.75rem 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: 10px;
            font-size: 0.95rem;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .control-group input:focus, .control-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }
        
        .challenge-btn {
            background: linear-gradient(135deg, var(--accent-color) 0%, #ea580c 100%);
            color: white;
            font-weight: 600;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .challenge-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* --- Enhanced Venn Diagram Area --- */
        .interactive-area { 
            text-align: center; 
        }
        
        #statement-display, #analysis-statement-display {
            background: linear-gradient(135deg, rgba(240, 253, 250, 0.7) 0%, rgba(250, 250, 250, 0.9) 100%);
            border-left: 4px solid var(--primary-color);
            padding: 1.25rem 1.75rem;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            font-size: 1.05rem;
            min-height: 60px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        #statement-display:hover, #analysis-statement-display:hover {
            box-shadow: var(--shadow-md);
        }
        
        .venn-container { 
            position: relative; 
            width: 100%; 
            max-width: 400px; 
            margin: 0 auto;
            padding: 1rem;
        }
        
        .venn-box {
            width: 100%;
            max-width: 400px;
            height: 400px;
            margin: 0 auto;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        
        .venn-box:hover:not(.locked) {
            box-shadow: var(--shadow-lg);
            transform: scale(1.01);
        }
        
        .venn-box.locked {
            cursor: default;
            filter: grayscale(0.2) brightness(0.98);
        }
        
        .fail-region {
            cursor: pointer;
            opacity: 0;
            pointer-events: all;
            transition: opacity 0.2s ease;
        }
        
        .fail-region.visible {
            opacity: 1;
        }
        
        #venn-tooltip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(31, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            color: white;
            padding: 0.625rem 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            text-align: center;
            width: 240px;
            box-shadow: var(--shadow-lg);
        }
        
        #venn-tooltip.visible {
            opacity: 1;
        }
        
        .venn-legend {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(250, 250, 250, 0.9) 0%, rgba(245, 247, 250, 0.6) 100%);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }
        
        .legend-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 0.625rem;
            border-radius: 10px;
            transition: background-color 0.2s ease;
        }
        
        .legend-item:hover {
            background-color: rgba(20, 184, 166, 0.05);
        }
        
        .legend-item:not(:last-child) {
            margin-bottom: 0.75rem;
        }
        
        .legend-key {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease;
        }
        
        .legend-key:hover {
            transform: scale(1.08);
        }
        
        .legend-key.p-key {
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
        }
        
        .legend-key.q-key {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* --- Enhanced Feedback & Forms --- */
        .feedback-box {
            margin: 1.5rem auto;
            padding: 1.75rem;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(250, 250, 250, 0.95) 100%);
            box-shadow: var(--shadow-md);
            max-width: 500px;
            text-align: center;
            font-size: 1rem;
        }
        
        .form-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .form-section h3 {
            color: var(--text-color);
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .form-section p {
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
        }
        
        .truth-radios {
            display: flex;
            gap: 1.5rem;
            margin: 0.5rem 0;
        }
        
        .truth-radios label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--medium-gray);
            border-radius: 10px;
            transition: all 0.2s ease;
            font-weight: 500;
            background: white;
        }
        
        .truth-radios label:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
            transform: translateY(-1px);
        }
        
        .truth-radios input[type="radio"]:checked + label {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        /* Style the Check Answer button specifically */
        .form-section button[type="submit"] {
            padding: 0.875rem 2.5rem;
            background: var(--gradient-2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            box-shadow: var(--shadow-md);
            margin-top: 0.5rem;
        }
        
        .form-section button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .form-section button[type="submit"]:disabled {
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        #info-card {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        #info-card h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
        }
        
        #info-card.success {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.04) 100%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.15);
        }
        
        #info-card.error {
            border-color: var(--error-color);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.04) 100%);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.15);
        }
        
        .hidden {
            display: none;
        }
        
        /* --- Enhanced Analysis Tab --- */
        .analysis-reveal-container {
            margin: 1.5rem 0;
            text-align: center;
        }
        
        .reveal-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.75rem;
        }
        
        .reveal-btn {
            padding: 0.625rem 1.25rem;
            background: var(--gradient-2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .reveal-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .reveal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
            margin-top: 1.5rem;
        }
        
        @media (min-width: 700px) {
            .analysis-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .analysis-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(250, 250, 250, 0.95) 100%);
            border: 1px solid rgba(229, 231, 235, 0.6);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.5s ease;
        }
        
        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .analysis-card:hover::before {
            opacity: 1;
        }
        
        .analysis-card h4 {
            color: var(--text-color);
            margin-bottom: 0.625rem;
            font-size: 1.15rem;
            font-weight: 700;
        }
        
        .analysis-card .form {
            font-style: italic;
            color: var(--dark-gray);
            margin-bottom: 1rem;
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .truth-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-left: 0.625rem;
            box-shadow: var(--shadow-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .truth-badge.true {
            background: linear-gradient(135deg, var(--success-color) 0%, #16a34a 100%);
            color: white;
        }
        
        .truth-badge.false {
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
            color: white;
        }
        
        .analysis-text p {
            margin-bottom: 0.625rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        /* Warning notice for fallback */
        .warning-notice {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            color: #92400e;
            padding: 0.625rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            border-left: 3px solid var(--warning-color);
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

    </style>
    <!-- Mathswell app navbar styles -->
<style>
  .mathswell-nav {
    display: flex;
    justify-content: center;
    margin: .4rem 0 1rem;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  .mathswell-nav .mw-link {
    display: inline-flex;
    align-items: center;
    gap: .45rem;
    text-decoration: none;
    font-weight: 700;
    font-size: 1rem;
    color: #0f766e;
    padding: .3rem .7rem;
    border-radius: 999px;
    background: rgba(255,255,255,.9);
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
  }
  .mathswell-nav .mw-link img {
    display: block;
  }
</style>
</head>
<body>
    <div class="container">
        <h1>If-Then: A Logic Explorer</h1>
         <!-- Mathswell brand badge -->
<div style="display:flex;justify-content:center;margin:.75rem 0 1rem;
            position:relative;z-index:1001;">
  <a href="https://mathswell.com" style="display:inline-flex;align-items:center;gap:.5rem;
      text-decoration:none;font-weight:800;font-size:1.05rem;color:#0f766e;
      padding:.4rem .8rem;border-radius:999px;background:#fff;
      box-shadow:0 1px 4px rgba(0,0,0,.08);">
    <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28" style="display:block">
    <span>MATHSWELL</span>
  </a>
</div>
        
        <div class="tabs">
            <button class="tab active" data-tab="intro">Learn</button>
            <button class="tab" data-tab="lab">Practice</button>
            <button class="tab" data-tab="analysis">Analysis</button>
        </div>

        <!-- Introduction Tab Content -->
        <div id="intro" class="tab-content active">
            <div class="intro-container">
                <div class="intro-section" style="margin-top: 1rem; margin-bottom: 1.5rem;">
                    <h2 style="margin-top: 0;">Understanding Conditional Statements</h2>
                    <p class="intro-text" style="margin-bottom: 1rem;">
                        A conditional statement "If P, then Q" describes a logical relationship between two parts:
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="background: var(--primary-light); padding: 1.5rem; border-radius: 12px;">
                            <h3 style="margin-top: 0; margin-bottom: 0.5rem;">Hypothesis (P)</h3>
                            <p style="margin: 0;">The "if" part - the condition that triggers the conclusion</p>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%); padding: 1.5rem; border-radius: 12px;">
                            <h3 style="margin-top: 0; margin-bottom: 0.5rem; color: var(--secondary-color);">Conclusion (Q)</h3>
                            <p style="margin: 0;">The "then" part - what must follow when P is true</p>
                        </div>
                    </div>
                </div>

                <div class="intro-section" style="margin-bottom: 1.5rem;">
                    <h2 style="margin-top: 1.5rem;">Visualizing with Venn Diagrams</h2>
                    <p class="intro-text" style="margin-bottom: 1rem;">
                        Click to explore how different arrangements represent different logical relationships:
                    </p>
                    
                    <div class="scenarios-grid" style="margin-bottom: 1.5rem;">
                        <div class="scenario-card" onclick="showScenario('p-in-q', this)">
                            <h4 style="margin-bottom: 0.5rem;">P inside Q</h4>
                            <p style="margin: 0;">Every P is also a Q</p>
                        </div>
                        <div class="scenario-card" onclick="showScenario('q-in-p', this)">
                            <h4 style="margin-bottom: 0.5rem;">Q inside P</h4>
                            <p style="margin: 0;">Every Q is also a P</p>
                        </div>
                        <div class="scenario-card" onclick="showScenario('overlap', this)">
                            <h4 style="margin-bottom: 0.5rem;">P and Q overlap</h4>
                            <p style="margin: 0;">Some P are Q, some aren't</p>
                        </div>
                        <div class="scenario-card" onclick="showScenario('disjoint', this)">
                            <h4 style="margin-bottom: 0.5rem;">P and Q separate</h4>
                            <p style="margin: 0;">No P is Q</p>
                        </div>
                    </div>
                    
                    <div class="venn-display" style="padding: 1.5rem;">
                        <svg id="intro-venn" viewBox="-1 -1 2 2" width="280" height="280">
                            <!-- Default: P inside Q -->
                            <circle cx="0" cy="0" r="0.62" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"></circle>
                            <text x="0" y="-0.75" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                            <circle cx="0" cy="0" r="0.35" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"></circle>
                            <text x="0" y="0.05" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                        </svg>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--primary-light); border-radius: 12px;">
                        <p style="font-weight: 600; margin-bottom: 0.25rem;">📌 Key Insight:</p>
                        <p style="margin: 0;">"If P, then Q" is true ONLY when P is entirely inside Q. In all other arrangements, counterexamples exist (P true, Q false).</p>
                    </div>
                </div>

                <div class="intro-section" style="margin-bottom: 1.5rem;">
                    <h2 style="margin-top: 1.5rem;">Real Examples</h2>
                    
                    <div class="example-box" style="margin-bottom: 1rem;">
                        <h4 style="margin-top: 0; margin-bottom: 0.5rem;">Example 1: Numbers</h4>
                        <p style="margin-bottom: 0.25rem;"><strong>Statement:</strong> "If a number is divisible by 6, then it is divisible by 3"</p>
                        <p style="margin-bottom: 0.25rem;"><strong>TRUE</strong> - Every multiple of 6 is also a multiple of 3.</p>
                        <p style="margin: 0;">The "divisible by 6" circle fits entirely inside "divisible by 3".</p>
                    </div>
                    
                    <div class="example-box" style="margin-bottom: 1rem;">
                        <h4 style="margin-top: 0; margin-bottom: 0.5rem;">Example 2: Geometry</h4>
                        <p style="margin-bottom: 0.25rem;"><strong>Statement:</strong> "If a shape is a square, then it has four sides"</p>
                        <p style="margin-bottom: 0.25rem;"><strong>TRUE</strong> - Every square has exactly four sides.</p>
                        <p style="margin: 0;">Note: The reverse isn't true - rectangles have 4 sides but aren't squares!</p>
                    </div>
                    
                    <div class="example-box">
                        <h4 style="margin-top: 0; margin-bottom: 0.5rem;">Finding Counterexamples</h4>
                        <p style="margin-bottom: 0.25rem;">A statement is false if you find even one case where P is true but Q is false.</p>
                        <p style="margin-bottom: 0.25rem;"><strong>Example:</strong> "If a number is prime, then it is odd"</p>
                        <p style="margin: 0;"><strong>Counterexample:</strong> 2 is prime but even → FALSE</p>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem; margin-bottom: 0;">
                    <p class="intro-text" style="margin-bottom: 1rem;">Ready to test your understanding?</p>
                    <button class="btn-secondary" onclick="switchToTab('lab')" style="font-size: 1.1rem; padding: 1rem 2rem;">
                        Start Practicing →
                    </button>
                </div>
            </div>
        </div>

        <!-- Logic Lab Tab Content -->
        <div id="lab" class="tab-content">
            <div class="lab-intro-box">
                <p><strong>Welcome to the Logic Lab!</strong></p>
                <ul>
                    <li>Use the controls to generate a new logic problem with AI.</li>
                    <li>Analyze the "Converse" statement that appears.</li>
                    <li>If it's false, provide your own counterexample and have the AI check it!</li>
                </ul>
                <p class="ai-disclaimer">Please note: The AI helper can make mistakes and may be temporarily unavailable during periods of high traffic.</p>
            </div>
            <div class="controls-grid">
                <div class="control-group">
                    <label for="categorySelect">1. Choose a Category</label>
                    <select id="categorySelect">
                        <option value="Numbers">Numbers</option>
                        <option value="Geometry">Geometry</option>
                        <option value="Number Theory">Number Theory</option>
                        <option value="Calculus">Calculus</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="difficultySelect">2. Choose a Difficulty</label>
                    <select id="difficultySelect">
                        <option value="Foundation">Foundation</option>
                        <option value="Medium">Medium</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>
                <div class="control-group generate-button-container">
                    <button id="generateBtn">🤖 Generate a Problem with AI</button>
                </div>
            </div>

            <div class="interactive-area">
                <h2>Generated Problem</h2>
                <div id="statement-display">
                    <p>Select a category and difficulty, then click "Generate" to create a new problem.</p>
                </div>
                <div class="venn-container">
                    <div id="venn-box" class="venn-box"></div>
                    <div id="venn-tooltip"></div>
                </div>
                <div id="venn-legend" class="venn-legend" style="display: none;"></div>
                <div id="analysis-box" class="feedback-box" style="display: none;">
                    <!-- Step 1: Ask True/False -->
                    <form id="truthCheckForm" class="form-section">
                        <h3>Is the Converse ("If Q, then P") True or False?</h3>
                        <p id="converse-statement"></p>
                        <div class="truth-radios">
                            <label><input type="radio" name="truth" value="true"> True</label>
                            <label><input type="radio" name="truth" value="false"> False</label>
                        </div>
                        <button type="submit" class="control-group button">Check Answer</button>
                    </form>
                    <!-- Step 2: Ask for Counterexample -->
                    <form id="counterexampleForm" class="form-section hidden">
                        <h3>You're right, it's false!</h3>
                        <p>Please provide a counterexample below.</p>
                        <div class="control-group" style="width:100%;">
                           <input type="text" id="counterexampleInput" placeholder="Enter your counterexample here" required>
                        </div>
                        <button type="submit" class="control-group button">Check Counterexample</button>
                    </form>
                    <!-- Step 3: Show Final Feedback -->
                    <div id="info-card" class="hidden"></div>
                     <!-- Step 4: Challenge AI -->
                    <form id="challengeForm" class="form-section hidden">
                        <h3>Challenge the AI's Assessment</h3>
                        <p>If you believe the AI is incorrect, please explain your reasoning.</p>
                         <div class="control-group" style="width:100%;">
                           <textarea id="challengeInput" rows="3" placeholder="My reasoning is..." required></textarea>
                        </div>
                        <button type="submit" class="control-group button">Submit Challenge</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Analysis Lab Tab Content -->
        <div id="analysis" class="tab-content">
            <div class="lab-intro-box">
                <p><strong>Welcome to the Analysis Lab!</strong></p>
                <p>Explore the complete logical breakdown of your problem. Click each button to reveal different forms and their relationships.</p>
            </div>
            <div id="analysis-statement-display">
                <p>Generate a problem in the "Practice" tab first to see the analysis here.</p>
            </div>
            
            <div class="analysis-reveal-container">
                <h3>Explore Related Forms</h3>
                <p>Click to reveal each logical form one at a time:</p>
                <div class="reveal-buttons">
                    <button class="reveal-btn" id="revealConverse" onclick="revealStatement('converse')">Converse</button>
                    <button class="reveal-btn" id="revealInverse" onclick="revealStatement('inverse')" disabled>Inverse</button>
                    <button class="reveal-btn" id="revealContrapositive" onclick="revealStatement('contrapositive')" disabled>Contrapositive</button>
                    <button class="reveal-btn" id="revealConditions" onclick="revealStatement('conditions')" disabled>Conditions</button>
                </div>
            </div>
            
            <div id="analysis-grid" class="analysis-grid">
                <!-- Cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

<script>
    // --- STATE MANAGEMENT ---
    let state = {
        category: 'Numbers',
        difficulty: 'Foundation',
        currentProblem: null,
        lastAIResponse: '', // Store AI reasoning for challenges
        isLocked: false,
        previousProblems: [], // Store previous problems to avoid duplicates
        revealedStatements: []
    };

    // --- FALLBACK PROBLEMS ---
    const FALLBACK_PROBLEMS = {
        "Numbers": {
            p: "a number is divisible by 4",
            q: "it is even",
            not_p: "a number is not divisible by 4",
            not_q: "it is not even",
            converse: { 
                statement: "If a number is even, then it is divisible by 4", 
                truth: false, 
                counterexample: "$6$" 
            },
            inverse: { 
                statement: "If a number is not divisible by 4, then it is not even", 
                truth: false, 
                counterexample: "$2$" 
            },
            contrapositive: { 
                statement: "If a number is not even, then it is not divisible by 4", 
                truth: true, 
                counterexample: null 
            }
        },
        "Geometry": {
            p: "a shape is a rectangle",
            q: "it has four right angles",
            not_p: "a shape is not a rectangle",
            not_q: "it does not have four right angles",
            converse: { 
                statement: "If a shape has four right angles, then it is a rectangle", 
                truth: false, 
                counterexample: "square" 
            },
            inverse: { 
                statement: "If a shape is not a rectangle, then it does not have four right angles", 
                truth: false, 
                counterexample: "square" 
            },
            contrapositive: { 
                statement: "If a shape does not have four right angles, then it is not a rectangle", 
                truth: true, 
                counterexample: null 
            }
        },
        "Number Theory": {
            p: "a number is a perfect square",
            q: "its square root is a real number",
            not_p: "a number is not a perfect square",
            not_q: "its square root is not a real number",
            converse: { 
                statement: "If a number's square root is real, then it is a perfect square", 
                truth: false, 
                counterexample: "$2$" 
            },
            inverse: { 
                statement: "If a number is not a perfect square, then its square root is not real", 
                truth: false, 
                counterexample: "$2$" 
            },
            contrapositive: { 
                statement: "If a number's square root is not real, then it is not a perfect square", 
                truth: true, 
                counterexample: null 
            }
        },
        "Calculus": {
            p: "a function is differentiable at a point",
            q: "it is continuous at that point",
            not_p: "a function is not differentiable at a point",
            not_q: "it is not continuous at that point",
            converse: { 
                statement: "If a function is continuous at a point, then it is differentiable at that point", 
                truth: false, 
                counterexample: "$|x|$ at $x=0$" 
            },
            inverse: { 
                statement: "If a function is not differentiable at a point, then it is not continuous at that point", 
                truth: false, 
                counterexample: "$|x|$ at $x=0$" 
            },
            contrapositive: { 
                statement: "If a function is not continuous at a point, then it is not differentiable at that point", 
                truth: true, 
                counterexample: null 
            }
        }
    };

    // --- DOM ELEMENTS ---
    const categorySelect = document.getElementById('categorySelect');
    const difficultySelect = document.getElementById('difficultySelect');
    const generateBtn = document.getElementById('generateBtn');
    const statementDisplay = document.getElementById('statement-display');
    const analysisStatementDisplay = document.getElementById('analysis-statement-display');
    const vennBox = document.getElementById('venn-box');
    const vennTooltip = document.getElementById('venn-tooltip');
    const vennLegend = document.getElementById('venn-legend');
    const analysisBox = document.getElementById('analysis-box');
    const analysisGrid = document.getElementById('analysis-grid');
    // Forms
    const truthCheckForm = document.getElementById('truthCheckForm');
    const counterexampleForm = document.getElementById('counterexampleForm');
    const challengeForm = document.getElementById('challengeForm');
    // Form Inputs/Display
    const converseStatement = document.getElementById('converse-statement');
    const counterexampleInput = document.getElementById('counterexampleInput');
    const challengeInput = document.getElementById('challengeInput');
    const infoCard = document.getElementById('info-card');

    // --- INTRO TAB FUNCTIONS ---
    function showScenario(scenario, element) {
        // Update active state
        document.querySelectorAll('.scenario-card').forEach(card => {
            card.classList.remove('active');
        });
        element.classList.add('active');
        
        // Update SVG
        const svg = document.getElementById('intro-venn');
        svg.innerHTML = '';
        
        switch(scenario) {
            case 'p-in-q':
                svg.innerHTML = `
                    <circle cx="0" cy="0" r="0.62" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"></circle>
                    <text x="0" y="-0.75" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                    <circle cx="0" cy="0" r="0.35" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"></circle>
                    <text x="0" y="0.05" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                `;
                break;
            case 'q-in-p':
                svg.innerHTML = `
                    <circle cx="0" cy="0" r="0.62" fill="rgba(15, 118, 110, 0.1)" stroke="#0f766e" stroke-width="0.03"></circle>
                    <text x="0" y="-0.75" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                    <circle cx="0" cy="0" r="0.35" fill="rgba(124, 58, 237, 0.2)" stroke="#7c3aed" stroke-width="0.03"></circle>
                    <text x="0" y="0.05" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                `;
                break;
            case 'overlap':
                svg.innerHTML = `
                    <circle cx="-0.25" cy="0" r="0.45" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"></circle>
                    <text x="-0.25" y="-0.55" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                    <circle cx="0.25" cy="0" r="0.45" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"></circle>
                    <text x="0.25" y="-0.55" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                `;
                break;
            case 'disjoint':
                svg.innerHTML = `
                    <circle cx="-0.4" cy="0" r="0.3" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"></circle>
                    <text x="-0.4" y="-0.4" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                    <circle cx="0.4" cy="0" r="0.3" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"></circle>
                    <text x="0.4" y="-0.4" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                `;
                break;
        }
    }

    function switchToTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-tab='${tabName}']`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
    }

    // --- TAB SWITCHING LOGIC ---
    document.querySelector('.tabs').addEventListener('click', e => {
        if (e.target.matches('.tab')) {
            const tabId = e.target.dataset.tab;
            switchToTab(tabId);
            if (tabId === 'analysis' && state.currentProblem) {
                displayAnalysis();
            }
        }
    });

    // --- IMPROVED AI FUNCTIONS ---
    
    // Extract and validate JSON from AI response
    function extractAndValidateJSON(text) {
        let data;
        
        // Try direct parse first
        try {
            data = JSON.parse(text);
        } catch {
            // Extract JSON from mixed text
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('No JSON found in response');
            }
            
            const cleaned = jsonMatch[0]
                .replace(/```json\s*/g, '')
                .replace(/```\s*/g, '')
                .trim();
            
            try {
                data = JSON.parse(cleaned);
            } catch (e) {
                throw new Error('Invalid JSON format');
            }
        }
        
        // Validate required fields
        const required = ['p', 'q', 'converse', 'inverse', 'contrapositive'];
        for (const field of required) {
            if (!(field in data)) {
                throw new Error(`Missing required field: ${field}`);
            }
        }
        
        // Validate statement structures
        for (const type of ['converse', 'inverse', 'contrapositive']) {
            const stmt = data[type];
            if (!stmt.statement || typeof stmt.truth !== 'boolean') {
                throw new Error(`Invalid ${type} structure`);
            }
            if (stmt.truth === false && !stmt.counterexample) {
                // Provide a default counterexample if missing
                stmt.counterexample = "example needed";
            }
        }
        
        // Add not_p and not_q if missing
        if (!data.not_p) {
            data.not_p = `not (${data.p})`;
        }
        if (!data.not_q) {
            data.not_q = `not (${data.q})`;
        }
        
        return data;
    }
    
    // Call AI with retry logic
    async function callAI(prompt, retries = 2) {
        for (let i = 0; i <= retries; i++) {
            try {
                if (i > 0) {
                    // Wait before retry: 1s, 2s, 4s
                    await new Promise(r => setTimeout(r, Math.pow(2, i-1) * 1000));
                }
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ role: "user", parts: [{ text: prompt }] }] 
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error('Empty response from AI');
                }
                
                state.lastAIResponse = text; // Store raw response
                return text;
                
            } catch (error) {
                if (i === retries) {
                    throw error;
                }
                console.log(`Attempt ${i + 1} failed, retrying...`);
            }
        }
    }

    async function generateProblem() {
        generateBtn.disabled = true;
        generateBtn.textContent = "🧠 Thinking...";
        statementDisplay.innerHTML = `<p>Generating problem... This may take a moment.</p>`;
        analysisStatementDisplay.innerHTML = `<p>Generating a new problem...</p>`;
        analysisGrid.innerHTML = '';
        
        // Remove any existing warning notices
        document.querySelectorAll('.warning-notice').forEach(n => n.remove());
        
        // Create a list of previous problems to avoid
        const previousPStatements = state.previousProblems.map(p => p.p).join(', ');
        
        const prompt = `
            You are a mathematics educator creating a logic problem.
            Generate an 'If P, then Q' conditional statement about "${state.category}" with a difficulty of "${state.difficulty}".
            
            IMPORTANT: Avoid these previous problems: ${previousPStatements || 'None yet'}
            Create a NEW and DIFFERENT problem.
            
            OUTPUT FORMAT - Return ONLY valid JSON:
            {
              "p": "hypothesis statement",
              "q": "conclusion statement",
              "not_p": "negation of p",
              "not_q": "negation of q",
              "converse": {
                "statement": "If q, then p",
                "truth": boolean,
                "counterexample": "example or null"
              },
              "inverse": {
                "statement": "If not p, then not q",
                "truth": boolean,
                "counterexample": "example or null"
              },
              "contrapositive": {
                "statement": "If not q, then not p",
                "truth": true,
                "counterexample": null
              }
            }
            
            RULES:
            - 'If P, then Q' must be logically TRUE
            - Contrapositive is always TRUE
            - Use $...$ for LaTeX math notation
            - Provide specific counterexamples when false
            - No markdown, no extra text, ONLY JSON
        `;
        
        try {
            // Try AI generation with retries
            const response = await callAI(prompt, 2);
            state.currentProblem = extractAndValidateJSON(response);
            
            // Store this problem to avoid duplicates
            state.previousProblems.push({
                p: state.currentProblem.p,
                q: state.currentProblem.q
            });
            
            // Keep only last 10 problems
            if (state.previousProblems.length > 10) {
                state.previousProblems.shift();
            }
            
        } catch (error) {
            console.error("AI generation failed:", error);
            
            // Use fallback problem
            state.currentProblem = FALLBACK_PROBLEMS[state.category];
            
            // Show subtle warning notice
            const notice = document.createElement('div');
            notice.className = 'warning-notice';
            notice.innerHTML = '⚠️ Using backup problem (AI temporarily unavailable)';
            statementDisplay.parentElement.insertBefore(notice, statementDisplay);
            
            // Auto-remove notice after 5 seconds
            setTimeout(() => notice.remove(), 5000);
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = "🤖 Generate a Problem with AI";
        }
        
        resetInteractiveState();
        displayProblem();
    }
    
    function typesetMath(elements) {
        if (window.MathJax && window.MathJax.startup?.promise) {
            window.MathJax.startup.promise.then(() => {
                window.MathJax.typesetPromise(elements).catch((err) => console.log('MathJax Typeset Error: ' + err.message));
            });
        }
    }

    function resetInteractiveState() {
        state.isLocked = false;
        state.revealedStatements = [];
        analysisBox.style.display = 'none';
        vennLegend.style.display = 'none';
        [truthCheckForm, counterexampleForm, infoCard, challengeForm].forEach(el => el.classList.add('hidden'));
        truthCheckForm.classList.remove('hidden');
        truthCheckForm.reset();
        counterexampleForm.reset();
        challengeForm.reset();
    }

    function displayProblem() {
        const { p, q } = state.currentProblem;
        statementDisplay.innerHTML = `
            <p><strong>If P, then Q:</strong> If ${p}, then ${q}.</p>
            <p><em>(This statement is guaranteed to be true.)</em></p>
        `;
        buildInteractiveVenn(false);
        converseStatement.innerHTML = state.currentProblem.converse.statement;
        analysisBox.style.display = 'block';
        typesetMath([statementDisplay, converseStatement]);
    }
    
    // --- UI FLOW & EVENT HANDLERS ---
    
    function handleTruthCheckSubmit(e) {
        e.preventDefault();
        const userAnswer = truthCheckForm.truth.value === 'true';
        const isCorrect = userAnswer === state.currentProblem.converse.truth;

        handleVennClick(); // Lock the diagram
        truthCheckForm.classList.add('hidden');

        if (isCorrect) {
            if (userAnswer === true) { // Correctly identified as TRUE
                showResult('success', `<h3>Correct!</h3><p>The converse statement is indeed <strong>TRUE</strong>.</p>`);
            } else { // Correctly identified as FALSE
                counterexampleForm.classList.remove('hidden');
            }
        } else { // Incorrectly identified
            const truthText = state.currentProblem.converse.truth ? "TRUE" : "FALSE";
            let feedback = `<h3>Not Quite.</h3><p>The converse statement is actually <strong>${truthText}</strong>.</p>`;
            if (!state.currentProblem.converse.truth) {
                feedback += `<p>A counterexample is: <strong>${state.currentProblem.converse.counterexample}</strong>.</p>`;
            }
            showResult('error', feedback);
        }
    }

    async function handleCounterexampleSubmit(e) {
        e.preventDefault();
        const userCounterexample = counterexampleInput.value;
        counterexampleForm.classList.add('hidden');
        showResult('loading', '<h3>Checking with AI...</h3>');

        const { p, q } = state.currentProblem;
        const prompt = `
            You are analyzing: "If ${q}, then ${p}."
            Proposed counterexample: "${userCounterexample}"
            A valid counterexample must make "${q}" true and "${p}" false.
            
            Be brief and direct. Use LaTeX for math.
            If valid: "Yes, that works because..."
            If invalid: "Not quite..." and explain which condition fails.
        `;

        try {
            const aiFeedback = await callAI(prompt, 1);
            const isCorrect = aiFeedback.toLowerCase().startsWith('yes');
            showResult(isCorrect ? 'success' : 'error', `<h3>AI Feedback:</h3><p>${aiFeedback}</p>`);
        } catch (error) {
            console.error("AI check failed:", error);
            // Provide a generic response when AI fails
            showResult('success', `<h3>Response:</h3><p>Your counterexample "${userCounterexample}" has been recorded. Since Q is true but P is false, this could be a valid counterexample.</p>`);
        }
    }

    async function handleChallengeSubmit(e) {
        e.preventDefault();
        const userReasoning = challengeInput.value;
        challengeForm.classList.add('hidden');
        showResult('loading', '<h3>Re-evaluating with AI...</h3>');

        const prompt = `
            You are re-evaluating your previous assessment.
            Original: If P, then Q is "If ${state.currentProblem.p}, then ${state.currentProblem.q}".
            Converse analyzed: "If ${state.currentProblem.q}, then ${state.currentProblem.p}".
            Your previous response: "${state.lastAIResponse}"
            Challenge reasoning: "${userReasoning}"

            Be brief. Use LaTeX for math.
            If you were wrong, admit it and correct.
            If you were right, explain the flaw in their reasoning.
        `;
        
        try {
            const aiReevaluation = await callAI(prompt, 1);
            showResult('neutral', `<h3>AI Re-evaluation:</h3><p>${aiReevaluation}</p>`);
        } catch (error) {
            console.error("AI re-evaluation failed:", error);
            showResult('neutral', `<h3>Re-evaluation:</h3><p>Thank you for your challenge. Your reasoning has been noted for consideration.</p>`);
        }
    }

    function showResult(type, htmlContent) {
        infoCard.className = ''; // Reset classes
        if (type === 'loading') {
            infoCard.innerHTML = htmlContent;
        } else if (type === 'neutral') {
            infoCard.innerHTML = htmlContent;
            infoCard.style.borderColor = 'var(--dark-gray)';
            infoCard.style.backgroundColor = '#f0f0f0';
        } else {
            infoCard.classList.add(type); // 'success' or 'error'
            infoCard.innerHTML = htmlContent;
            const challengeBtn = document.createElement('button');
            challengeBtn.className = 'control-group button challenge-btn';
            challengeBtn.textContent = '🤔 Challenge AI\'s Assessment';
            challengeBtn.onclick = () => {
                challengeForm.classList.remove('hidden');
                infoCard.classList.add('hidden');
            };
            infoCard.appendChild(challengeBtn);
        }
        infoCard.classList.remove('hidden');
        typesetMath([infoCard]);
    }

    // --- INTERACTIVE VENN DIAGRAM ---
    function buildInteractiveVenn(locked) {
        vennBox.innerHTML = '';
        vennBox.className = locked ? 'venn-box locked' : 'venn-box';
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('viewBox', '-1 -1 2 2');

        const { p, q, converse } = state.currentProblem;
        const converse_truth = converse.truth;
        const RP = converse_truth ? 0.62 : 0.40, RQ = 0.62;

        const defs = document.createElementNS(svgNS, "defs");
        defs.innerHTML = `
            <pattern id="failPattern" patternUnits='userSpaceOnUse' width='0.1' height='0.1'>
                <path d='M-0.02,0.1 l0.12,-0.12 M-0.02,0.02 l0.04,-0.04 M0.06,0.12 l0.04,-0.04' stroke='rgba(183,28,28,0.6)' stroke-width='0.02'/>
            </pattern>
        `;
        svg.appendChild(defs);

        const qCircleBase = document.createElementNS(svgNS, "circle");
        qCircleBase.setAttribute("cx", "0"); qCircleBase.setAttribute("cy", "0");
        qCircleBase.setAttribute("r", RQ); qCircleBase.setAttribute("fill", "rgba(21,101,192,0.1)");
        qCircleBase.setAttribute("stroke", "#555"); qCircleBase.setAttribute("stroke-width", "0.03");
        svg.appendChild(qCircleBase);

        let failRegionGroup = null;
        if (!converse_truth) {
            const maskId = "ringMask" + Date.now();
            const mask = document.createElementNS(svgNS, "mask");
            mask.setAttribute("id", maskId);
            
            const whiteCircle = document.createElementNS(svgNS, "circle");
            whiteCircle.setAttribute("cx", "0"); whiteCircle.setAttribute("cy", "0");
            whiteCircle.setAttribute("r", RQ); whiteCircle.setAttribute("fill", "white");
            mask.appendChild(whiteCircle);
            
            const blackCircle = document.createElementNS(svgNS, "circle");
            blackCircle.setAttribute("cx", "0"); blackCircle.setAttribute("cy", "0");
            blackCircle.setAttribute("r", RP); blackCircle.setAttribute("fill", "black");
            mask.appendChild(blackCircle);
            
            defs.appendChild(mask);

            failRegionGroup = document.createElementNS(svgNS, "g");
            failRegionGroup.classList.add("fail-region");
            if (locked) failRegionGroup.classList.add("visible");

            const stripedCircle = document.createElementNS(svgNS, "circle");
            stripedCircle.setAttribute("cx", "0"); stripedCircle.setAttribute("cy", "0");
            stripedCircle.setAttribute("r", RQ); stripedCircle.setAttribute("fill", "url(#failPattern)");
            stripedCircle.setAttribute("mask", `url(#${maskId})`);
            failRegionGroup.appendChild(stripedCircle);
            svg.appendChild(failRegionGroup);
        }
        
        const pCircleBase = document.createElementNS(svgNS, "circle");
        pCircleBase.setAttribute("cx", "0"); pCircleBase.setAttribute("cy", "0");
        pCircleBase.setAttribute("r", RP); pCircleBase.setAttribute("fill", "rgba(21,101,192,0.2)");
        pCircleBase.setAttribute("stroke", "#333"); pCircleBase.setAttribute("stroke-width", "0.03");
        svg.appendChild(pCircleBase);
        
        const qLabel = document.createElementNS(svgNS, "text");
        qLabel.setAttribute("x", "0"); qLabel.setAttribute("y", "-0.7");
        qLabel.setAttribute("fill", "#333"); qLabel.setAttribute("font-size", "0.25");
        qLabel.setAttribute("font-weight", "bold"); qLabel.setAttribute("text-anchor", "middle");
        qLabel.textContent = "Q";
        svg.appendChild(qLabel);

        const pLabel = document.createElementNS(svgNS, "text");
        pLabel.setAttribute("x", "0"); pLabel.setAttribute("y", "0.08");
        pLabel.setAttribute("fill", "#111");
        pLabel.setAttribute("font-size", "0.3");
        pLabel.setAttribute("font-weight", "bold");
        pLabel.setAttribute("text-anchor", "middle");
        pLabel.textContent = "P";
        svg.appendChild(pLabel);

        if (!converse_truth && !locked && failRegionGroup) {
            const clickArea = document.createElementNS(svgNS, "rect");
            clickArea.setAttribute('x', -1); clickArea.setAttribute('y', -1);
            clickArea.setAttribute('width', 2); clickArea.setAttribute('height', 2);
            clickArea.setAttribute('fill', 'transparent'); clickArea.style.cursor = 'pointer';

            clickArea.addEventListener('mousemove', (e) => {
                const rect = svg.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
                const r = Math.sqrt(x * x + y * y);
                
                if (r > RP && r <= RQ) {
                    failRegionGroup.classList.add('visible');
                    vennTooltip.classList.add('visible');
                } else {
                    failRegionGroup.classList.remove('visible');
                    vennTooltip.classList.remove('visible');
                }
            });
            
            clickArea.addEventListener('mouseleave', () => {
                if (!locked) {
                    failRegionGroup.classList.remove('visible');
                    vennTooltip.classList.remove('visible');
                }
            });

            clickArea.addEventListener('click', (e) => {
                const rect = svg.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
                const r = Math.sqrt(x * x + y * y);
                if (r > RP && r <= RQ) handleVennClick();
            });
            svg.appendChild(clickArea);
        }
        
        vennBox.appendChild(svg);
        
        vennLegend.style.display = 'block';
        vennLegend.innerHTML = `
            <div class="legend-item">
                <div class="legend-key p-key">P</div>
                <div><strong>Hypothesis (P):</strong> ${p}</div>
            </div>
            <div class="legend-item">
                <div class="legend-key q-key">Q</div>
                <div><strong>Conclusion (Q):</strong> ${q}</div>
            </div>
        `;
        typesetMath([vennLegend]);
        
        vennTooltip.textContent = `Counterexample region for "If Q, then P": Q is true, but P is false.`;
    }

    function handleVennClick() {
        if (state.isLocked) return;
        state.isLocked = true;
        buildInteractiveVenn(true);
    }
    
    // --- ANALYSIS TAB LOGIC ---
    function displayAnalysis() {
        if (!state.currentProblem) return;
        
        const { p, q } = state.currentProblem;

        analysisStatementDisplay.innerHTML = `
            <p><strong>Original Statement:</strong> If ${p}, then ${q}.</p>
        `;
        
        // Reset reveal state
        state.revealedStatements = [];
        analysisGrid.innerHTML = '';
        document.getElementById('revealConverse').disabled = false;
        document.getElementById('revealInverse').disabled = true;
        document.getElementById('revealContrapositive').disabled = true;
        document.getElementById('revealConditions').disabled = true;
        
        typesetMath([analysisStatementDisplay]);
    }
    
    function revealStatement(type) {
        if (!state.currentProblem || state.revealedStatements.includes(type)) return;
        
        state.revealedStatements.push(type);
        const { p, q, converse, inverse, contrapositive } = state.currentProblem;
        
        const card = document.createElement('div');
        card.className = 'analysis-card';
        
        switch(type) {
            case 'converse':
                card.innerHTML = `
                    <h4>Converse <span class="truth-badge ${converse.truth}">${converse.truth ? 'TRUE' : 'FALSE'}</span></h4>
                    <p class="form">If Q, then P</p>
                    <div class="analysis-text">
                        <p>${converse.statement}</p>
                        ${!converse.truth ? `<p><strong>Counterexample:</strong> ${converse.counterexample}</p>` : ''}
                    </div>
                `;
                document.getElementById('revealInverse').disabled = false;
                break;
                
            case 'inverse':
                card.innerHTML = `
                    <h4>Inverse <span class="truth-badge ${inverse.truth}">${inverse.truth ? 'TRUE' : 'FALSE'}</span></h4>
                    <p class="form">If not P, then not Q</p>
                    <div class="analysis-text">
                        <p>${inverse.statement}</p>
                        ${!inverse.truth ? `<p><strong>Counterexample:</strong> ${inverse.counterexample}</p>` : ''}
                    </div>
                `;
                document.getElementById('revealContrapositive').disabled = false;
                break;
                
            case 'contrapositive':
                card.innerHTML = `
                    <h4>Contrapositive <span class="truth-badge ${contrapositive.truth}">${contrapositive.truth ? 'TRUE' : 'FALSE'}</span></h4>
                    <p class="form">If not Q, then not P</p>
                    <div class="analysis-text">
                        <p>${contrapositive.statement}</p>
                        <p><em>This is always logically equivalent to the original statement.</em></p>
                    </div>
                `;
                document.getElementById('revealConditions').disabled = false;
                break;
                
            case 'conditions':
                let conditionsHTML = `
                    <h4>Necessary & Sufficient Conditions</h4>
                    <div class="analysis-text">
                        <p><strong>Sufficient:</strong> Knowing that "${p}" is true is <strong>sufficient</strong> to conclude that "${q}" is true.</p>
                        <p><strong>Necessary:</strong> For "${p}" to be true, it is <strong>necessary</strong> that "${q}" is also true.</p>
                `;
                
                if (converse.truth) {
                    conditionsHTML += `
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--medium-gray);">
                        <p><strong>Biconditional:</strong> Because the converse is also true, the conditions are equivalent. P is <strong>necessary and sufficient</strong> for Q (and vice-versa).</p>
                    `;
                }
                
                conditionsHTML += `</div>`;
                card.innerHTML = conditionsHTML;
                break;
        }
        
        analysisGrid.appendChild(card);
        typesetMath([card]);
    }


    // --- EVENT LISTENERS ---
    categorySelect.addEventListener('change', (e) => state.category = e.target.value);
    difficultySelect.addEventListener('change', (e) => state.difficulty = e.target.value);
    generateBtn.addEventListener('click', generateProblem);
    truthCheckForm.addEventListener('submit', handleTruthCheckSubmit);
    counterexampleForm.addEventListener('submit', handleCounterexampleSubmit);
    challengeForm.addEventListener('submit', handleChallengeSubmit);

    // Initialize first scenario as active
    window.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.scenario-card').click();
    });

</script>
   
</body>
</html>






















