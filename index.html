<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>If-Then Logic Explorer | Mathswell</title>
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    
    <!-- MathJax for math rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* Root variables */
        :root {
            --primary: #0f766e;
            --primary-light: #10b981;
            --background: #f7faf9;
            --interactive: #e6fffb;
            --text-primary: #212121;
            --text-muted: #4b5563;
            --accent-amber: #f59e0b;
            --accent-red: #c62828;
            --success: #10b981;
        }
        
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            padding-top: 60px;
            min-height: 100vh;
        }
        
        /* CENTERED Navigation */
        .mathswell-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border-bottom: 2px solid var(--primary);
            padding: 0.75rem 1rem;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .mw-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--primary);
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        /* Container */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        /* MathPal Disclosure Banner */
        .ai-disclosure-banner {
            background: var(--interactive);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        /* CENTERED Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background: var(--interactive);
            color: var(--primary);
        }
        
        /* Tab content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Hero section */
        .hero-section {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .hero-section h1 {
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        /* Concept cards */
        .concept-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .concept-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .concept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .concept-card.active {
            border: 2px solid var(--primary);
            background: var(--interactive);
        }
        
        .concept-card h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Interactive demo */
        .interactive-demo {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        /* Preset pills */
        .preset-pill {
            padding: 0.4rem 1rem;
            border-radius: 999px;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0.25rem;
            display: inline-block;
        }
        
        .preset-pill:hover {
            background: var(--interactive);
            transform: translateY(-2px);
        }
        
        .preset-pill.active {
            background: var(--primary);
            color: white;
        }
        
        /* Info display boxes */
        .info-display {
            background: var(--interactive);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 0.75rem;
            font-family: 'Monaco', monospace;
        }
        
        /* Control panel */
        .control-panel {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 1.25rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        /* Navigation buttons */
        .nav-btn {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }
        
        .nav-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Explorer workspace with MathPal */
        .explorer-workspace {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .problem-section, .mathpal-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .problem-section h3, .mathpal-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Venn diagram styles */
        .venn-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .venn-box {
            margin: 1rem auto;
            max-width: 400px;
            position: relative;
            cursor: pointer;
        }
        
        .venn-box.locked {
            cursor: default;
        }
        
        /* Counterexample region styles */
        .fail-region {
            cursor: pointer;
            opacity: 0;
            pointer-events: all;
            transition: opacity 0.2s ease;
        }
        
        .fail-region.visible {
            opacity: 1;
        }
        
        #venn-tooltip {
            position: absolute;
            background: rgba(31, 41, 59, 0.9);
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            text-align: center;
            max-width: 200px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        #venn-tooltip.visible {
            opacity: 1;
        }
        
        /* Hint buttons */
        .hint-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .hint-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .hint-btn:hover {
            background: var(--interactive);
            transform: translateY(-1px);
        }
        
        /* Form controls */
        input, select, textarea {
            padding: 0.75rem;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 16px;
            min-height: 44px;
            width: 100%;
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
        }
        
        /* Truth radios */
        .truth-radios {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            justify-content: center;
        }
        
        .truth-radios label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.6rem 1.2rem;
            border: 2px solid var(--primary);
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: 500;
            background: white;
        }
        
        .truth-radios label:hover {
            background: var(--interactive);
            transform: translateY(-1px);
        }
        
        .truth-radios input[type="radio"]:checked + span {
            color: var(--primary);
        }
        
        /* MathPal animations */
        @keyframes mathpal-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        @keyframes robot-blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0.1; }
        }
        
        .robot-eye {
            animation: robot-blink 5s infinite;
        }
        
        .mathpal-icon {
            animation: mathpal-bob 2s ease-in-out infinite;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .control-panel {
                flex-direction: column;
            }
            
            .explorer-workspace {
                grid-template-columns: 1fr;
            }
            
            .concept-cards {
                grid-template-columns: 1fr;
            }
            
            input, button, select {
                font-size: 16px;
                min-height: 44px;
            }
        }
        
        /* Success/error states */
        .feedback-box {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .feedback-box.success {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid var(--success);
        }
        
        .feedback-box.error {
            background: rgba(198, 40, 40, 0.1);
            border: 2px solid var(--accent-red);
        }
        
        .feedback-box.hint {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--accent-amber);
        }
        
        /* Thinking animation */
        .thinking-dots {
            display: inline-block;
        }
        
        .thinking-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Analysis section */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .analysis-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .analysis-card h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .truth-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            font-weight: bold;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .truth-badge.true {
            background: var(--success);
            color: white;
        }
        
        .truth-badge.false {
            background: var(--accent-red);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Centered Mathswell Navigation -->
    <div class="mathswell-nav">
        <a href="/" class="mw-link">
            <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
            <span>MATHSWELL</span>
        </a>
    </div>
    
    <div class="container">
        <!-- MathPal Disclosure -->
        <div class="ai-disclosure-banner">
            <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
                <svg width="32" height="32" class="mathpal-icon">
                    <circle cx="16" cy="16" r="14" fill="#e6fffb"/>
                    <rect x="11" y="19" width="10" height="8" fill="#0f766e" rx="1"/>
                    <rect x="9" y="11" width="14" height="10" fill="#10b981" rx="2"/>
                    <line x1="16" y1="11" x2="16" y2="8" stroke="#0f766e" stroke-width="1"/>
                    <circle cx="16" cy="7" r="1" fill="#f59e0b"/>
                    <circle cx="13" cy="15" r="1.5" fill="white"/>
                    <circle cx="19" cy="15" r="1.5" fill="white"/>
                    <circle cx="13" cy="15" r="1" fill="#0f766e" class="robot-eye"/>
                    <circle cx="19" cy="15" r="1" fill="#0f766e" class="robot-eye"/>
                    <path d="M 13 18 Q 16 19 19 18" stroke="#0f766e" stroke-width="1" fill="none"/>
                </svg>
                <div style="text-align: left;">
                    <div style="font-weight: 600; color: var(--primary);">
                        MathPal - Your AI Study Buddy
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-muted);">
                        Learns alongside you • Can make mistakes • May be occasionally unavailable
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Centered Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="intro">Introduction</button>
            <button class="tab-btn" data-tab="explorer">Explorer with MathPal</button>
            <button class="tab-btn" data-tab="analysis">Analysis</button>
        </div>
        
        <!-- Tab 1: Introduction -->
        <div id="intro" class="tab-content active">
            <div class="hero-section">
                <h1>If-Then Logic Explorer</h1>
                <p>Master conditional statements through visual exploration!</p>
            </div>
            
            <div class="concept-cards">
                <div class="concept-card" onclick="highlightCard(this)">
                    <h3>📝 Hypothesis (P)</h3>
                    <p>The "if" part - the condition that triggers the conclusion</p>
                    <div class="info-display" style="margin-top: 0.5rem;">
                        <small>Example: "If x > 5..."</small>
                    </div>
                </div>
                
                <div class="concept-card" onclick="highlightCard(this)">
                    <h3>🎯 Conclusion (Q)</h3>
                    <p>The "then" part - what must follow when P is true</p>
                    <div class="info-display" style="margin-top: 0.5rem;">
                        <small>Example: "...then x² > 25"</small>
                    </div>
                </div>
                
                <div class="concept-card" onclick="highlightCard(this)">
                    <h3>⭕ Venn Diagrams</h3>
                    <p>"If P, then Q" means P is entirely inside Q</p>
                    <div style="margin-top: 0.5rem;">
                        <svg viewBox="-1 -1 2 2" width="80" height="80">
                            <circle cx="0" cy="0" r="0.6" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.02"/>
                            <circle cx="0" cy="0" r="0.3" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.02"/>
                            <text x="0" y="-0.7" fill="#7c3aed" font-size="0.15" text-anchor="middle">Q</text>
                            <text x="0" y="0" fill="#0f766e" font-size="0.15" text-anchor="middle">P</text>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="interactive-demo">
                <h2 style="color: var(--primary); margin-bottom: 1rem;">Interactive Demo</h2>
                <p style="margin-bottom: 1rem;">Click to explore different logical relationships:</p>
                
                <div style="display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem;">
                    <button class="preset-pill" onclick="showScenario('subset')">P ⊆ Q (True)</button>
                    <button class="preset-pill" onclick="showScenario('superset')">Q ⊆ P (False)</button>
                    <button class="preset-pill" onclick="showScenario('overlap')">P ∩ Q (False)</button>
                    <button class="preset-pill" onclick="showScenario('disjoint')">P ∩ Q = ∅ (False)</button>
                </div>
                
                <div id="demo-venn" class="venn-box">
                    <svg viewBox="-1 -1 2 2" width="280" height="280">
                        <circle cx="0" cy="0" r="0.62" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"/>
                        <text x="0" y="-0.75" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                        <circle cx="0" cy="0" r="0.35" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"/>
                        <text x="0" y="0.05" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                    </svg>
                </div>
                
                <div id="demo-explanation" class="info-display" style="margin-top: 1rem;">
                    <strong>Key Insight:</strong> "If P, then Q" is true only when P is entirely inside Q!
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="nav-btn" onclick="switchToTab('explorer')">
                    Try Explorer →
                </button>
            </div>
        </div>
        
        <!-- Tab 2: Explorer with MathPal -->
        <div id="explorer" class="tab-content">
            <div class="control-panel">
                <select id="categorySelect">
                    <option value="Numbers">Numbers</option>
                    <option value="Geometry">Geometry</option>
                    <option value="Number Theory">Number Theory</option>
                    <option value="Calculus">Calculus</option>
                </select>
                
                <select id="difficultySelect">
                    <option value="Foundation">Foundation</option>
                    <option value="Medium">Medium</option>
                    <option value="Advanced">Advanced</option>
                </select>
                
                <button id="generateBtn" class="nav-btn">🤖 Generate Problem</button>
                <button onclick="resetExplorer()" class="hint-btn">Reset</button>
            </div>
            
            <div class="venn-container">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Visualization</h3>
                <div id="statement-display" class="info-display">
                    <p>Select options and click "Generate Problem" to begin.</p>
                </div>
                
                <div id="venn-box" class="venn-box">
                    <!-- Venn diagram will be inserted here -->
                </div>
                <div id="venn-tooltip"></div>
                
                <div id="venn-legend" style="display: none; margin-top: 1rem; text-align: left;">
                    <!-- Legend will be inserted here -->
                </div>
            </div>
            
            <div class="explorer-workspace" id="explorer-workspace" style="display: none;">
                <div class="problem-section">
                    <h3>📝 Your Analysis</h3>
                    
                    <div id="problem-display" class="info-display" style="margin-bottom: 1rem;">
                        <!-- Problem will be displayed here -->
                    </div>
                    
                    <form id="truthCheckForm">
                        <label style="font-weight: 600; color: var(--primary);">Is the converse true or false?</label>
                        <div class="truth-radios">
                            <label><input type="radio" name="truth" value="true"><span>True</span></label>
                            <label><input type="radio" name="truth" value="false"><span>False</span></label>
                        </div>
                        <button type="submit" class="nav-btn" style="width: 100%;">Check Answer</button>
                    </form>
                    
                    <form id="counterexampleForm" style="display: none; margin-top: 1rem;">
                        <label style="font-weight: 600; color: var(--primary);">Provide a counterexample:</label>
                        <input type="text" id="counterexampleInput" placeholder="Enter your counterexample" style="margin-top: 0.5rem;">
                        <button type="submit" class="nav-btn" style="margin-top: 0.5rem; width: 100%;">Check My Work</button>
                    </form>
                    
                    <div id="feedback-box" class="feedback-box" style="display: none;"></div>
                </div>
                
                <div class="mathpal-section">
                    <h3>
                        <svg width="24" height="24">
                            <circle cx="12" cy="12" r="10" fill="#e6fffb"/>
                            <rect x="8" y="14" width="8" height="6" fill="#0f766e" rx="1"/>
                            <rect x="7" y="8" width="10" height="7" fill="#10b981" rx="2"/>
                            <circle cx="9" cy="11" r="1" fill="white"/>
                            <circle cx="15" cy="11" r="1" fill="white"/>
                            <circle cx="9" cy="11" r="0.7" fill="#0f766e" class="robot-eye"/>
                            <circle cx="15" cy="11" r="0.7" fill="#0f766e" class="robot-eye"/>
                            <path d="M 9 13 Q 12 14 15 13" stroke="#0f766e" stroke-width="0.8" fill="none"/>
                        </svg>
                        MathPal's Thinking
                    </h3>
                    
                    <div id="mathpal-response" class="info-display">
                        <p>Hey! I'm working on this problem too. Let me think about it...</p>
                    </div>
                    
                    <div class="hint-buttons">
                        <button onclick="getHint('nudge')" class="hint-btn">💭 Nudge</button>
                        <button onclick="getHint('collaborate')" class="hint-btn">🤝 Collaborate</button>
                        <button onclick="getHint('reveal')" class="hint-btn">💡 Reveal</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: Analysis -->
        <div id="analysis" class="tab-content">
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                <h2 style="color: var(--primary); margin-bottom: 1rem;">Interactive Logic Analysis</h2>
                
                <div id="analysis-statement" class="info-display" style="margin-bottom: 1.5rem;">
                    <p>Generate a problem in Explorer first to see the analysis here.</p>
                </div>
                
                <div id="analysis-controls" style="display: none; margin-bottom: 2rem;">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <p style="color: var(--text-muted);">Click each form to reveal and explore:</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                        <button class="preset-pill" onclick="revealForm('original')" id="btn-original">Original</button>
                        <button class="preset-pill" onclick="revealForm('converse')" id="btn-converse">Converse</button>
                        <button class="preset-pill" onclick="revealForm('inverse')" id="btn-inverse" disabled>Inverse</button>
                        <button class="preset-pill" onclick="revealForm('contrapositive')" id="btn-contrapositive" disabled>Contrapositive</button>
                    </div>
                </div>
                
                <div id="analysis-workspace" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div id="analysis-form-display" style="background: var(--interactive); padding: 1.5rem; border-radius: 8px;">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">Selected Form</h3>
                            <div id="analysis-form-content">
                                <p>Click a button above to explore a logical form.</p>
                            </div>
                        </div>
                        
                        <div id="analysis-venn-display" style="background: #f7faf9; padding: 1.5rem; border-radius: 8px;">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">Visual Representation</h3>
                            <div id="analysis-venn-box">
                                <!-- Mini Venn diagram will go here -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="analysis-quiz" style="display: none; background: white; padding: 1.5rem; border: 2px solid var(--primary); border-radius: 8px;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">Test Your Understanding</h4>
                        <div id="quiz-question"></div>
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                            <button class="hint-btn" onclick="checkQuizAnswer(true)">True</button>
                            <button class="hint-btn" onclick="checkQuizAnswer(false)">False</button>
                        </div>
                        <div id="quiz-feedback" style="margin-top: 1rem; display: none;"></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="nav-btn" onclick="showRelationships()">🔄 Show All Relationships</button>
                        <button class="hint-btn" onclick="startQuiz()">📝 Test Yourself</button>
                    </div>
                </div>
                
                <div id="analysis-grid" class="analysis-grid" style="display: none;">
                    <!-- Analysis cards will be inserted here when "Show All" is clicked -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // State management
        let state = {
            currentProblem: null,
            category: 'Numbers',
            difficulty: 'Foundation',
            isLocked: false,
            attemptCount: 0,
            maxAttempts: 2,
            previousProblems: [],
            currentQuiz: null
        };
        
        // Fallback problems
        const FALLBACK_PROBLEMS = {
            "Numbers": {
                p: "a number is divisible by 4",
                q: "it is even",
                not_p: "a number is not divisible by 4",
                not_q: "it is not even",
                converse: { 
                    statement: "If a number is even, then it is divisible by 4", 
                    truth: false, 
                    counterexample: "6 is even but not divisible by 4" 
                },
                inverse: { 
                    statement: "If a number is not divisible by 4, then it is not even", 
                    truth: false, 
                    counterexample: "2 is not divisible by 4 but is even" 
                },
                contrapositive: { 
                    statement: "If a number is not even, then it is not divisible by 4", 
                    truth: true, 
                    counterexample: null 
                }
            },
            "Geometry": {
                p: "a shape is a rectangle",
                q: "it has four right angles",
                not_p: "a shape is not a rectangle",
                not_q: "it does not have four right angles",
                converse: { 
                    statement: "If a shape has four right angles, then it is a rectangle", 
                    truth: false, 
                    counterexample: "A square has four right angles but is a special type of rectangle" 
                },
                inverse: { 
                    statement: "If a shape is not a rectangle, then it does not have four right angles", 
                    truth: false, 
                    counterexample: "A square is technically a rectangle but the point stands" 
                },
                contrapositive: { 
                    statement: "If a shape does not have four right angles, then it is not a rectangle", 
                    truth: true, 
                    counterexample: null 
                }
            }
        };
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                switchToTab(tabId);
            });
        });
        
        function switchToTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab='${tabName}']`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'analysis' && state.currentProblem) {
                displayAnalysis();
            }
        }
        
        // Introduction tab functions
        function highlightCard(card) {
            document.querySelectorAll('.concept-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
        }
        
        function showScenario(type) {
            const svg = document.querySelector('#demo-venn svg');
            const explanation = document.getElementById('demo-explanation');
            
            svg.innerHTML = '';
            
            switch(type) {
                case 'subset':
                    svg.innerHTML = `
                        <circle cx="0" cy="0" r="0.62" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"/>
                        <text x="0" y="-0.75" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                        <circle cx="0" cy="0" r="0.35" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"/>
                        <text x="0" y="0.05" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                    `;
                    explanation.innerHTML = '<strong>✓ TRUE:</strong> Every P is inside Q, so "If P, then Q" holds!';
                    break;
                    
                case 'superset':
                    svg.innerHTML = `
                        <circle cx="0" cy="0" r="0.62" fill="rgba(15, 118, 110, 0.1)" stroke="#0f766e" stroke-width="0.03"/>
                        <text x="0" y="-0.75" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                        <circle cx="0" cy="0" r="0.35" fill="rgba(124, 58, 237, 0.2)" stroke="#7c3aed" stroke-width="0.03"/>
                        <text x="0" y="0.05" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                    `;
                    explanation.innerHTML = '<strong>✗ FALSE:</strong> Some P are outside Q, creating counterexamples!';
                    break;
                    
                case 'overlap':
                    svg.innerHTML = `
                        <circle cx="-0.25" cy="0" r="0.45" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"/>
                        <text x="-0.25" y="-0.55" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                        <circle cx="0.25" cy="0" r="0.45" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"/>
                        <text x="0.25" y="-0.55" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                    `;
                    explanation.innerHTML = '<strong>✗ FALSE:</strong> Some P are not in Q, so the statement fails!';
                    break;
                    
                case 'disjoint':
                    svg.innerHTML = `
                        <circle cx="-0.4" cy="0" r="0.3" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.03"/>
                        <text x="-0.4" y="-0.4" fill="#0f766e" font-size="0.15" font-weight="bold" text-anchor="middle">P</text>
                        <circle cx="0.4" cy="0" r="0.3" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.03"/>
                        <text x="0.4" y="-0.4" fill="#7c3aed" font-size="0.15" font-weight="bold" text-anchor="middle">Q</text>
                    `;
                    explanation.innerHTML = '<strong>✗ FALSE:</strong> No P is in Q, so the statement completely fails!';
                    break;
            }
            
            document.querySelectorAll('.preset-pill').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        // Explorer tab functions
        document.getElementById('categorySelect').addEventListener('change', (e) => {
            state.category = e.target.value;
        });
        
        document.getElementById('difficultySelect').addEventListener('change', (e) => {
            state.difficulty = e.target.value;
        });
        
        document.getElementById('generateBtn').addEventListener('click', generateProblem);
        
        async function callAI(prompt, retries = 2) {
            for (let i = 0; i <= retries; i++) {
                try {
                    if (i > 0) {
                        await new Promise(r => setTimeout(r, Math.pow(2, i-1) * 1000));
                    }
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ role: "user", parts: [{ text: prompt }] }] 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        throw new Error('Empty response from AI');
                    }
                    
                    return text;
                    
                } catch (error) {
                    if (i === retries) {
                        throw error;
                    }
                }
            }
        }
        
        async function generateProblem() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = '🧠 Thinking...';
            
            const previousPStatements = state.previousProblems.map(p => p.p).join(', ');
            
            const prompt = `
                You are a mathematics educator creating a logic problem.
                Generate an 'If P, then Q' conditional statement about "${state.category}" with difficulty "${state.difficulty}".
                
                IMPORTANT: Avoid these previous problems: ${previousPStatements || 'None yet'}
                
                OUTPUT FORMAT - Return ONLY valid JSON:
                {
                  "p": "hypothesis statement",
                  "q": "conclusion statement",
                  "not_p": "negation of p",
                  "not_q": "negation of q",
                  "converse": {
                    "statement": "If q, then p",
                    "truth": boolean,
                    "counterexample": "example or null"
                  },
                  "inverse": {
                    "statement": "If not p, then not q",
                    "truth": boolean,
                    "counterexample": "example or null"
                  },
                  "contrapositive": {
                    "statement": "If not q, then not p",
                    "truth": true,
                    "counterexample": null
                  }
                }
                
                RULES:
                - 'If P, then Q' must be logically TRUE
                - Contrapositive is always TRUE
                - Use $...$ for LaTeX math notation
                - Provide specific counterexamples when false
                - No markdown, no extra text, ONLY JSON
            `;
            
            try {
                const response = await callAI(prompt, 2);
                state.currentProblem = extractAndValidateJSON(response);
                
                state.previousProblems.push({
                    p: state.currentProblem.p,
                    q: state.currentProblem.q
                });
                
                if (state.previousProblems.length > 10) {
                    state.previousProblems.shift();
                }
                
            } catch (error) {
                console.error('AI generation failed:', error);
                state.currentProblem = FALLBACK_PROBLEMS[state.category] || FALLBACK_PROBLEMS["Numbers"];
                
                document.getElementById('statement-display').innerHTML = `
                    <p style="color: var(--accent-amber); margin-bottom: 0.5rem;">
                        ⚠️ Using backup problem (AI temporarily unavailable)
                    </p>
                    <p><strong>Statement:</strong> If ${state.currentProblem.p}, then ${state.currentProblem.q}.</p>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = '🤖 Generate Problem';
            }
            
            resetInteractiveState();
            displayProblem();
        }
        
        function extractAndValidateJSON(text) {
            let data;
            
            try {
                data = JSON.parse(text);
            } catch {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('No JSON found in response');
                }
                
                const cleaned = jsonMatch[0]
                    .replace(/```json\s*/g, '')
                    .replace(/```\s*/g, '')
                    .trim();
                
                try {
                    data = JSON.parse(cleaned);
                } catch (e) {
                    throw new Error('Invalid JSON format');
                }
            }
            
            const required = ['p', 'q', 'converse', 'inverse', 'contrapositive'];
            for (const field of required) {
                if (!(field in data)) {
                    throw new Error(`Missing required field: ${field}`);
                }
            }
            
            return data;
        }
        
        function resetInteractiveState() {
            state.isLocked = false;
            state.attemptCount = 0;
            document.getElementById('explorer-workspace').style.display = 'none';
            document.getElementById('truthCheckForm').reset();
            document.getElementById('truthCheckForm').style.display = 'block';
            document.getElementById('counterexampleForm').style.display = 'none';
            document.getElementById('counterexampleForm').reset();
            document.getElementById('feedback-box').style.display = 'none';
        }
        
        function displayProblem() {
            const { p, q } = state.currentProblem;
            
            document.getElementById('statement-display').innerHTML = `
                <p><strong>Original Statement:</strong> If ${p}, then ${q}.</p>
                <p style="font-size: 0.85rem; color: var(--text-muted);">(This statement is guaranteed to be true.)</p>
            `;
            
            buildInteractiveVenn(false);
            
            document.getElementById('venn-legend').style.display = 'block';
            document.getElementById('venn-legend').innerHTML = `
                <div style="display: flex; gap: 2rem;">
                    <div><span style="color: var(--primary); font-weight: bold;">P:</span> ${p}</div>
                    <div><span style="color: #7c3aed; font-weight: bold;">Q:</span> ${q}</div>
                </div>
            `;
            
            document.getElementById('explorer-workspace').style.display = 'grid';
            
            document.getElementById('problem-display').innerHTML = `
                <strong>Original:</strong> If ${p}, then ${q}.<br>
                <strong>Converse:</strong> ${state.currentProblem.converse.statement}
            `;
            
            document.getElementById('mathpal-response').innerHTML = `
                <p>Alright, I see we're looking at the converse!</p>
                <p>I'm trying to figure out if every case where "${q}" is true also means "${p}" is true.</p>
            `;
            
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }
        
        function buildInteractiveVenn(locked) {
            const vennBox = document.getElementById('venn-box');
            vennBox.innerHTML = '';
            vennBox.className = locked ? 'venn-box locked' : 'venn-box';
            
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', '-1 -1 2 2');
            
            const { converse } = state.currentProblem;
            const RP = 0.40, RQ = 0.62;
            
            // Add pattern for counterexample region
            const defs = document.createElementNS(svgNS, "defs");
            defs.innerHTML = `
                <pattern id="failPattern" patternUnits='userSpaceOnUse' width='0.1' height='0.1'>
                    <path d='M-0.02,0.1 l0.12,-0.12 M-0.02,0.02 l0.04,-0.04 M0.06,0.12 l0.04,-0.04' 
                          stroke='rgba(183,28,28,0.6)' stroke-width='0.02'/>
                </pattern>
            `;
            svg.appendChild(defs);
            
            // Q circle
            const qCircle = document.createElementNS(svgNS, "circle");
            qCircle.setAttribute("cx", "0");
            qCircle.setAttribute("cy", "0");
            qCircle.setAttribute("r", RQ);
            qCircle.setAttribute("fill", "rgba(124, 58, 237, 0.1)");
            qCircle.setAttribute("stroke", "#7c3aed");
            qCircle.setAttribute("stroke-width", "0.03");
            svg.appendChild(qCircle);
            
            // Counterexample region (if converse is false)
            let failRegionGroup = null;
            if (!converse.truth) {
                const maskId = "ringMask" + Date.now();
                const mask = document.createElementNS(svgNS, "mask");
                mask.setAttribute("id", maskId);
                
                const whiteCircle = document.createElementNS(svgNS, "circle");
                whiteCircle.setAttribute("cx", "0");
                whiteCircle.setAttribute("cy", "0");
                whiteCircle.setAttribute("r", RQ);
                whiteCircle.setAttribute("fill", "white");
                mask.appendChild(whiteCircle);
                
                const blackCircle = document.createElementNS(svgNS, "circle");
                blackCircle.setAttribute("cx", "0");
                blackCircle.setAttribute("cy", "0");
                blackCircle.setAttribute("r", RP);
                blackCircle.setAttribute("fill", "black");
                mask.appendChild(blackCircle);
                
                defs.appendChild(mask);
                
                failRegionGroup = document.createElementNS(svgNS, "g");
                failRegionGroup.classList.add("fail-region");
                if (locked) failRegionGroup.classList.add("visible");
                
                const stripedCircle = document.createElementNS(svgNS, "circle");
                stripedCircle.setAttribute("cx", "0");
                stripedCircle.setAttribute("cy", "0");
                stripedCircle.setAttribute("r", RQ);
                stripedCircle.setAttribute("fill", "url(#failPattern)");
                stripedCircle.setAttribute("mask", `url(#${maskId})`);
                failRegionGroup.appendChild(stripedCircle);
                svg.appendChild(failRegionGroup);
            }
            
            // P circle
            const pCircle = document.createElementNS(svgNS, "circle");
            pCircle.setAttribute("cx", "0");
            pCircle.setAttribute("cy", "0");
            pCircle.setAttribute("r", RP);
            pCircle.setAttribute("fill", "rgba(15, 118, 110, 0.2)");
            pCircle.setAttribute("stroke", "#0f766e");
            pCircle.setAttribute("stroke-width", "0.03");
            svg.appendChild(pCircle);
            
            // Labels
            const qLabel = document.createElementNS(svgNS, "text");
            qLabel.setAttribute("x", "0");
            qLabel.setAttribute("y", "-0.7");
            qLabel.setAttribute("fill", "#7c3aed");
            qLabel.setAttribute("font-size", "0.25");
            qLabel.setAttribute("font-weight", "bold");
            qLabel.setAttribute("text-anchor", "middle");
            qLabel.textContent = "Q";
            svg.appendChild(qLabel);
            
            const pLabel = document.createElementNS(svgNS, "text");
            pLabel.setAttribute("x", "0");
            pLabel.setAttribute("y", "0.08");
            pLabel.setAttribute("fill", "#0f766e");
            pLabel.setAttribute("font-size", "0.3");
            pLabel.setAttribute("font-weight", "bold");
            pLabel.setAttribute("text-anchor", "middle");
            pLabel.textContent = "P";
            svg.appendChild(pLabel);
            
            // Interactive area for hover
            if (!converse.truth && !locked && failRegionGroup) {
                const clickArea = document.createElementNS(svgNS, "rect");
                clickArea.setAttribute('x', -1);
                clickArea.setAttribute('y', -1);
                clickArea.setAttribute('width', 2);
                clickArea.setAttribute('height', 2);
                clickArea.setAttribute('fill', 'transparent');
                clickArea.style.cursor = 'pointer';
                
                clickArea.addEventListener('mousemove', (e) => {
                    const rect = svg.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
                    const r = Math.sqrt(x * x + y * y);
                    
                    const tooltip = document.getElementById('venn-tooltip');
                    
                    if (r > RP && r <= RQ) {
                        failRegionGroup.classList.add('visible');
                        tooltip.textContent = 'Counterexample region: Q is true, but P is false';
                        tooltip.style.left = (e.clientX - rect.left) + 'px';
                        tooltip.style.top = (e.clientY - rect.top - 40) + 'px';
                        tooltip.classList.add('visible');
                    } else {
                        failRegionGroup.classList.remove('visible');
                        tooltip.classList.remove('visible');
                    }
                });
                
                clickArea.addEventListener('mouseleave', () => {
                    if (!locked) {
                        failRegionGroup.classList.remove('visible');
                        document.getElementById('venn-tooltip').classList.remove('visible');
                    }
                });
                
                clickArea.addEventListener('click', (e) => {
                    const rect = svg.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
                    const r = Math.sqrt(x * x + y * y);
                    if (r > RP && r <= RQ) {
                        state.isLocked = true;
                        buildInteractiveVenn(true);
                    }
                });
                
                svg.appendChild(clickArea);
            }
            
            vennBox.appendChild(svg);
        }
        
        // Form submission handlers
        document.getElementById('truthCheckForm').addEventListener('submit', handleTruthCheckSubmit);
        document.getElementById('counterexampleForm').addEventListener('submit', handleCounterexampleSubmit);
        
        function handleTruthCheckSubmit(e) {
            e.preventDefault();
            const userAnswer = document.querySelector('input[name="truth"]:checked')?.value === 'true';
            const isCorrect = userAnswer === state.currentProblem.converse.truth;
            state.attemptCount++;
            
            const feedbackBox = document.getElementById('feedback-box');
            feedbackBox.style.display = 'block';
            
            if (isCorrect) {
                if (userAnswer === false) {
                    // Show counterexample form
                    document.getElementById('truthCheckForm').style.display = 'none';
                    document.getElementById('counterexampleForm').style.display = 'block';
                    document.getElementById('mathpal-response').innerHTML = `
                        <p>Yeah, I think you're right! It does seem false to me too.</p>
                        <p>Can you find a counterexample? I'm trying to think of one where "${state.currentProblem.q}" is true but "${state.currentProblem.p}" is false...</p>
                    `;
                    feedbackBox.style.display = 'none';
                } else {
                    // Converse is true
                    feedbackBox.className = 'feedback-box success';
                    feedbackBox.innerHTML = `<strong>Excellent!</strong> The converse is indeed TRUE. This means P and Q are equivalent!`;
                    document.getElementById('mathpal-response').innerHTML = `
                        <p>Nice! I got the same answer - the converse is true!</p>
                        <p>That means P and Q are actually equivalent. Every P is Q, and every Q is P!</p>
                    `;
                }
            } else {
                // Wrong answer
                feedbackBox.className = 'feedback-box error';
                feedbackBox.innerHTML = `<strong>Not quite.</strong> Think about whether every case where "${state.currentProblem.q}" is true implies "${state.currentProblem.p}" is true.`;
                
                if (state.attemptCount >= state.maxAttempts) {
                    buildInteractiveVenn(true);
                    const truthText = state.currentProblem.converse.truth ? "TRUE" : "FALSE";
                    feedbackBox.innerHTML += `<br><br>The converse is actually <strong>${truthText}</strong>.`;
                    if (!state.currentProblem.converse.truth) {
                        feedbackBox.innerHTML += ` For example: ${state.currentProblem.converse.counterexample}`;
                    }
                }
            }
        }
        
        async function handleCounterexampleSubmit(e) {
            e.preventDefault();
            const userExample = document.getElementById('counterexampleInput').value;
            
            const feedbackBox = document.getElementById('feedback-box');
            feedbackBox.style.display = 'block';
            feedbackBox.className = 'feedback-box';
            feedbackBox.innerHTML = '<p class="thinking-dots">Checking your counterexample</p>';
            
            const { p, q } = state.currentProblem;
            const prompt = `
                You are MathPal, a friendly peer study buddy (not a teacher).
                
                The CONVERSE statement is: "If ${q}, then ${p}."
                User's proposed counterexample: "${userExample}"
                
                To be a valid counterexample to the converse:
                - "${userExample}" must satisfy "${q}" (making Q true)
                - "${userExample}" must NOT satisfy "${p}" (making P false)
                
                Check if this is valid. Respond casually like a peer: "I got...", "Let me check..."
                Keep it to 2-3 sentences. Be encouraging whether they're right or wrong.
                Use $ for LaTeX if needed.
            `;
            
            try {
                const response = await callAI(prompt, 1);
                feedbackBox.className = 'feedback-box success';
                feedbackBox.innerHTML = `<strong>MathPal says:</strong><br>${response}`;
                document.getElementById('mathpal-response').innerHTML = `<p>${response}</p>`;
                buildInteractiveVenn(true);
            } catch (error) {
                // AI unavailable - provide fallback
                feedbackBox.className = 'feedback-box hint';
                feedbackBox.innerHTML = `
                    <strong>Note:</strong> I can't check your specific example right now (MathPal is temporarily unavailable).
                    <br><br>
                    One possible counterexample would be: "${state.currentProblem.converse.counterexample}"
                    <br><br>
                    For a valid counterexample, we need something where "${q}" is true but "${p}" is false.
                `;
                document.getElementById('mathpal-response').innerHTML = `
                    <p>Hmm, I'm having trouble connecting right now.</p>
                    <p>But I think we need to find something where "${q}" is true but "${p}" is false.</p>
                    <p>One example might be: ${state.currentProblem.converse.counterexample}</p>
                `;
                buildInteractiveVenn(true);
            }
            
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }
        
        function getHint(level) {
            const { p, q, converse } = state.currentProblem;
            
            const responses = {
                'nudge': `
                    <p>Want a hint? Let's think about this together!</p>
                    <p>We need to check if every case where "${q}" is true also means "${p}" is true.</p>
                    <p>Can you think of any examples where that might not work?</p>
                `,
                'collaborate': `
                    <p>Let's work through this step by step!</p>
                    <p>The converse says: ${converse.statement}</p>
                    <p>I'm trying to think of specific examples... What about you?</p>
                `,
                'reveal': `
                    <p>Okay, here's what I found:</p>
                    <p>The converse is <strong>${converse.truth ? 'TRUE' : 'FALSE'}</strong>.</p>
                    ${!converse.truth ? 
                        `<p>A counterexample I found: ${converse.counterexample}</p>` : 
                        '<p>P and Q are actually equivalent - cool, right?</p>'
                    }
                `
            };
            
            document.getElementById('mathpal-response').innerHTML = responses[level];
            
            if (level === 'reveal') {
                buildInteractiveVenn(true);
            }
        }
        
        function resetExplorer() {
            state.currentProblem = null;
            state.isLocked = false;
            state.attemptCount = 0;
            
            document.getElementById('statement-display').innerHTML = '<p>Select options and click "Generate Problem" to begin.</p>';
            document.getElementById('venn-box').innerHTML = '';
            document.getElementById('venn-legend').style.display = 'none';
            document.getElementById('explorer-workspace').style.display = 'none';
            document.getElementById('truthCheckForm').reset();
            document.getElementById('counterexampleForm').reset();
            document.getElementById('feedback-box').style.display = 'none';
        }
        
        function displayAnalysis() {
            if (!state.currentProblem) {
                document.getElementById('analysis-statement').innerHTML = 
                    '<p>Generate a problem in Explorer first to see the analysis here.</p>';
                document.getElementById('analysis-controls').style.display = 'none';
                document.getElementById('analysis-workspace').style.display = 'none';
                document.getElementById('analysis-grid').style.display = 'none';
                return;
            }
            
            const { p, q } = state.currentProblem;
            
            document.getElementById('analysis-statement').innerHTML = `
                <p><strong>Original Statement:</strong> If ${p}, then ${q}.</p>
                <p style="font-size: 0.9rem; color: var(--text-muted);">Explore each logical form interactively below!</p>
            `;
            
            // Reset buttons
            document.querySelectorAll('#analysis-controls button').forEach(btn => {
                btn.classList.remove('active');
                btn.disabled = false;
            });
            document.getElementById('btn-inverse').disabled = true;
            document.getElementById('btn-contrapositive').disabled = true;
            
            // Show controls and workspace
            document.getElementById('analysis-controls').style.display = 'block';
            document.getElementById('analysis-workspace').style.display = 'block';
            document.getElementById('analysis-grid').style.display = 'none';
            document.getElementById('analysis-quiz').style.display = 'none';
            
            // Reset content
            document.getElementById('analysis-form-content').innerHTML = '<p>Click a button above to explore a logical form.</p>';
            document.getElementById('analysis-venn-box').innerHTML = '';
            
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }
        
        function revealForm(formType) {
            if (!state.currentProblem) return;
            
            const { p, q, not_p, not_q, converse, inverse, contrapositive } = state.currentProblem;
            
            // Update button states
            document.querySelectorAll('#analysis-controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${formType}`).classList.add('active');
            
            let content = '';
            let vennType = 'original';
            
            switch(formType) {
                case 'original':
                    content = `
                        <h4 style="color: var(--primary);">Original Statement</h4>
                        <p><strong>If P, then Q:</strong></p>
                        <p style="font-style: italic; background: white; padding: 0.75rem; border-radius: 4px;">
                            If ${p}, then ${q}.
                        </p>
                        <p style="margin-top: 1rem;"><strong>Truth Value:</strong> <span class="truth-badge true">TRUE</span></p>
                        <p style="font-size: 0.9rem; color: var(--text-muted);">This is our given true statement.</p>
                    `;
                    vennType = 'original';
                    document.getElementById('btn-converse').disabled = false;
                    break;
                    
                case 'converse':
                    content = `
                        <h4 style="color: var(--primary);">Converse</h4>
                        <p><strong>If Q, then P:</strong></p>
                        <p style="font-style: italic; background: white; padding: 0.75rem; border-radius: 4px;">
                            ${converse.statement}
                        </p>
                        <p style="margin-top: 1rem;"><strong>Truth Value:</strong> <span class="truth-badge ${converse.truth}">${converse.truth ? 'TRUE' : 'FALSE'}</span></p>
                        ${!converse.truth ? `<p><strong>Counterexample:</strong> ${converse.counterexample}</p>` : '<p>P and Q are equivalent!</p>'}
                    `;
                    vennType = converse.truth ? 'equivalent' : 'converse-false';
                    document.getElementById('btn-inverse').disabled = false;
                    break;
                    
                case 'inverse':
                    content = `
                        <h4 style="color: var(--primary);">Inverse</h4>
                        <p><strong>If not P, then not Q:</strong></p>
                        <p style="font-style: italic; background: white; padding: 0.75rem; border-radius: 4px;">
                            ${inverse.statement}
                        </p>
                        <p style="margin-top: 1rem;"><strong>Truth Value:</strong> <span class="truth-badge ${inverse.truth}">${inverse.truth ? 'TRUE' : 'FALSE'}</span></p>
                        ${!inverse.truth ? `<p><strong>Counterexample:</strong> ${inverse.counterexample}</p>` : ''}
                    `;
                    vennType = 'inverse';
                    document.getElementById('btn-contrapositive').disabled = false;
                    break;
                    
                case 'contrapositive':
                    content = `
                        <h4 style="color: var(--primary);">Contrapositive</h4>
                        <p><strong>If not Q, then not P:</strong></p>
                        <p style="font-style: italic; background: white; padding: 0.75rem; border-radius: 4px;">
                            ${contrapositive.statement}
                        </p>
                        <p style="margin-top: 1rem;"><strong>Truth Value:</strong> <span class="truth-badge true">TRUE</span></p>
                        <p style="font-size: 0.9rem; color: var(--text-muted);">Always equivalent to the original statement!</p>
                    `;
                    vennType = 'contrapositive';
                    break;
            }
            
            document.getElementById('analysis-form-content').innerHTML = content;
            drawAnalysisVenn(vennType);
            
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }
        
        function drawAnalysisVenn(type) {
            const container = document.getElementById('analysis-venn-box');
            
            let svgContent = '';
            switch(type) {
                case 'original':
                    svgContent = `
                        <svg viewBox="-1 -1 2 2" width="200" height="200">
                            <circle cx="0" cy="0" r="0.6" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.02"/>
                            <circle cx="0" cy="0" r="0.35" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.02"/>
                            <text x="0" y="-0.7" fill="#7c3aed" font-size="0.15" text-anchor="middle">Q</text>
                            <text x="0" y="0" fill="#0f766e" font-size="0.15" text-anchor="middle">P</text>
                            <text x="0" y="0.85" fill="#333" font-size="0.12" text-anchor="middle">P ⊆ Q</text>
                        </svg>
                    `;
                    break;
                    
                case 'equivalent':
                    svgContent = `
                        <svg viewBox="-1 -1 2 2" width="200" height="200">
                            <circle cx="0" cy="0" r="0.5" fill="rgba(15, 118, 110, 0.3)" stroke="#0f766e" stroke-width="0.03"/>
                            <text x="0" y="0" fill="#0f766e" font-size="0.15" text-anchor="middle">P = Q</text>
                            <text x="0" y="0.85" fill="#333" font-size="0.12" text-anchor="middle">Equivalent Sets</text>
                        </svg>
                    `;
                    break;
                    
                case 'converse-false':
                    svgContent = `
                        <svg viewBox="-1 -1 2 2" width="200" height="200">
                            <defs>
                                <pattern id="analysisPattern" patternUnits='userSpaceOnUse' width='0.1' height='0.1'>
                                    <path d='M0,0 l0.1,0.1 M0,0.1 l0.1,-0.1' stroke='rgba(220,38,127,0.3)' stroke-width='0.01'/>
                                </pattern>
                            </defs>
                            <circle cx="0" cy="0" r="0.6" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.02"/>
                            <circle cx="0" cy="0" r="0.35" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.02"/>
                            <path d="M 0,0 m -0.6,0 a 0.6,0.6 0 0,1 1.2,0 a 0.6,0.6 0 0,1 -1.2,0 
                                     M 0,0 m -0.35,0 a 0.35,0.35 0 0,0 0.7,0 a 0.35,0.35 0 0,0 -0.7,0" 
                                  fill="url(#analysisPattern)" fill-rule="evenodd"/>
                            <text x="0" y="-0.7" fill="#7c3aed" font-size="0.15" text-anchor="middle">Q</text>
                            <text x="0" y="0" fill="#0f766e" font-size="0.15" text-anchor="middle">P</text>
                            <text x="0" y="0.85" fill="#c62828" font-size="0.11" text-anchor="middle">Q ⊈ P (False)</text>
                        </svg>
                    `;
                    break;
                    
                case 'inverse':
                case 'contrapositive':
                    svgContent = `
                        <svg viewBox="-1 -1 2 2" width="200" height="200">
                            <circle cx="0" cy="0" r="0.6" fill="rgba(124, 58, 237, 0.1)" stroke="#7c3aed" stroke-width="0.02"/>
                            <circle cx="0" cy="0" r="0.35" fill="rgba(15, 118, 110, 0.2)" stroke="#0f766e" stroke-width="0.02"/>
                            <text x="0" y="-0.7" fill="#7c3aed" font-size="0.15" text-anchor="middle">Q</text>
                            <text x="0" y="0" fill="#0f766e" font-size="0.15" text-anchor="middle">P</text>
                            <text x="0" y="0.85" fill="#333" font-size="0.11" text-anchor="middle">
                                ${type === 'contrapositive' ? '¬Q ⊆ ¬P (True)' : '¬P ⊆ ¬Q (Varies)'}
                            </text>
                        </svg>
                    `;
                    break;
            }
            
            container.innerHTML = svgContent;
        }
        
        function startQuiz() {
            if (!state.currentProblem) return;
            
            const { converse, inverse } = state.currentProblem;
            const questions = [
                {
                    text: "The converse and the original statement always have the same truth value.",
                    answer: false,
                    explanation: "False! The converse can be false even when the original is true."
                },
                {
                    text: "The contrapositive always has the same truth value as the original statement.",
                    answer: true,
                    explanation: "True! The contrapositive is logically equivalent to the original."
                },
                {
                    text: `In this problem, the converse is ${converse.truth ? 'true' : 'false'}.`,
                    answer: true,
                    explanation: `Correct! ${converse.truth ? 'P and Q are equivalent in this case.' : 'There are counterexamples to the converse.'}`
                },
                {
                    text: "If the converse is true, then P and Q describe the same set.",
                    answer: true,
                    explanation: "True! When both 'If P then Q' and 'If Q then P' are true, P = Q."
                }
            ];
            
            const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
            state.currentQuiz = randomQuestion;
            
            document.getElementById('analysis-quiz').style.display = 'block';
            document.getElementById('quiz-question').innerHTML = `<p style="font-size: 1.1rem;">${randomQuestion.text}</p>`;
            document.getElementById('quiz-feedback').style.display = 'none';
        }
        
        function checkQuizAnswer(userAnswer) {
            if (!state.currentQuiz) return;
            
            const isCorrect = userAnswer === state.currentQuiz.answer;
            const feedback = document.getElementById('quiz-feedback');
            
            feedback.style.display = 'block';
            feedback.className = isCorrect ? 'feedback-box success' : 'feedback-box error';
            feedback.innerHTML = `
                <strong>${isCorrect ? 'Correct!' : 'Not quite.'}</strong><br>
                ${state.currentQuiz.explanation}
            `;
            
            setTimeout(() => {
                document.getElementById('analysis-quiz').style.display = 'none';
            }, 3000);
        }
        
        function showRelationships() {
            if (!state.currentProblem) return;
            
            const { p, q, converse, inverse, contrapositive } = state.currentProblem;
            
            document.getElementById('analysis-grid').style.display = 'grid';
            document.getElementById('analysis-grid').innerHTML = `
                <div class="analysis-card">
                    <h4>Original <span class="truth-badge true">TRUE</span></h4>
                    <p style="font-style: italic; color: var(--text-muted);">If P, then Q</p>
                    <p>If ${p}, then ${q}.</p>
                </div>
                
                <div class="analysis-card">
                    <h4>Converse <span class="truth-badge ${converse.truth}">${converse.truth ? 'TRUE' : 'FALSE'}</span></h4>
                    <p style="font-style: italic; color: var(--text-muted);">If Q, then P</p>
                    <p>${converse.statement}</p>
                    ${!converse.truth ? `<p><strong>Counterexample:</strong> ${converse.counterexample}</p>` : ''}
                </div>
                
                <div class="analysis-card">
                    <h4>Inverse <span class="truth-badge ${inverse.truth}">${inverse.truth ? 'TRUE' : 'FALSE'}</span></h4>
                    <p style="font-style: italic; color: var(--text-muted);">If not P, then not Q</p>
                    <p>${inverse.statement}</p>
                    ${!inverse.truth ? `<p><strong>Counterexample:</strong> ${inverse.counterexample}</p>` : ''}
                </div>
                
                <div class="analysis-card">
                    <h4>Contrapositive <span class="truth-badge true">TRUE</span></h4>
                    <p style="font-style: italic; color: var(--text-muted);">If not Q, then not P</p>
                    <p>${contrapositive.statement}</p>
                    <p><em>Always equivalent to the original!</em></p>
                </div>
            `;
            
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }
    </script>
</body>
</html>
